@page "/"
@using DemoContentSafety.Models
@using DemoContentSafety.Services
@inject ITeamNameSafetyService SafetyService
@rendermode InteractiveServer

<PageTitle>チーム名登録</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <h1 class="mb-4">チーム名登録</h1>

            <EditForm Model="@teamNameModel" OnValidSubmit="@HandleValidSubmit" FormName="TeamNameForm">
                <DataAnnotationsValidator />
                
                <div class="mb-3">
                    <label for="teamName" class="form-label">チーム名</label>
                    <InputText id="teamName" 
                               @bind-Value="teamNameModel.TeamName" 
                               class="form-control" 
                               placeholder="例）Red Dragons" />
                    <ValidationMessage For="@(() => teamNameModel.TeamName)" class="text-danger" />
                </div>

                <button type="submit" class="btn btn-primary">登録</button>
            </EditForm>

            @if (!string.IsNullOrEmpty(message))
            {
                <div class="alert @messageClass mt-3" role="alert">
                    @message
                    @if (!string.IsNullOrEmpty(categoriesSummary))
                    {
                        <div class="mt-2">
                            <small><strong>詳細:</strong> @categoriesSummary</small>
                        </div>
                    }
                </div>
            }

            @if (registeredTeams.Count > 0)
            {
                <div class="mt-4">
                    <h3>登録済みチーム名一覧</h3>
                    <ul class="list-group">
                        @foreach (var team in registeredTeams)
                        {
                            <li class="list-group-item">@team</li>
                        }
                    </ul>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private TeamNameModel teamNameModel = new();
    private List<string> registeredTeams = new();
    private string message = string.Empty;
    private string messageClass = string.Empty;
    private string categoriesSummary = string.Empty;

    private async Task HandleValidSubmit()
    {
        // Content Safetyで検証
        var validationResult = await SafetyService.ValidateAsync(teamNameModel.TeamName);
        
        if (validationResult.IsValid)
        {
            // 登録成功
            registeredTeams.Add(teamNameModel.TeamName);
            message = validationResult.Message;
            messageClass = "alert-success";
            categoriesSummary = string.Empty;
            
            // フォームをリセット
            teamNameModel = new();
        }
        else
        {
            // 登録失敗
            message = validationResult.Message;
            messageClass = "alert-danger";
            categoriesSummary = validationResult.GetCategoriesSummary();
        }
    }
}
